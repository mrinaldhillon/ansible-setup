# roles/packages/tasks/main.yml
- name: Install required packages
  dnf:
    name: "{{ packages }}"
    state: present

- name: Set default to graphical.target
  systemd:
    name: graphical.target
    enabled: yes
    state: started

- name: Setup flatpak
  command: flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
  ignore_errors: true

- name: Install Flatpak applications
  flatpak:
    name: "{{ item }}"
    state: present
    remote: flathub
  loop: "{{ flatpaks }}"
  ignore_errors: true

- name: Create nvim-clean wrapper script
  copy:
    dest: /usr/local/bin/nvim-clean
    content: |
      #!/bin/sh
      exec nvim --clean "$@"
    mode: "0755"

- name: Set nvim-clean as alternative for vim
  command: update-alternatives --install /usr/bin/vim vim /usr/local/bin/nvim-clean 50
  args:
    creates: /etc/alternatives/vim

- name: Set nvim-clean as the default alternative for vim
  command: update-alternatives --set vim /usr/local/bin/nvim-clean

- name: Ensure 1Password Dir exists
  file:
    path: /opt/1Password
    state: directory
    mode: "0755"

- name: Download and install 1Password
  command: curl -sSo /tmp/1password-latest.tar.gz https://downloads.1password.com/linux/tar/stable/aarch64/1password-latest.tar.gz
  ignore_errors: true

- name: Extract 1Password
  unarchive:
    src: /tmp/1password-latest.tar.gz
    dest: /opt/1Password
    extra_opts: ["--strip-components=1", "--show-stored-names"]
    remote_src: yes
  ignore_errors: true

- name: Run 1Password post-install script
  command:
    cmd: /opt/1Password/after-install.sh
  ignore_errors: true

- name: setup binfmt_misc for x86
  shell: sed 's/$/C/' /usr/lib/binfmt.d/qemu-x86_64-static.conf > /etc/binfmt.d/qemu-x86_64-static.conf
  ignore_errors: true

- name: restart binfmt service
  command:
    cmd: systemctl restart systemd-binfmt.service
  ignore_errors: true
